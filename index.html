<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Devocional Photo Booth (GSR) ‚Äì 1 arquivo</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#0b0b0b;color:#eee}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:1.7fr 1fr;gap:16px}
  @media (max-width: 980px){ .row{grid-template-columns:1fr} }
  .card{background:#111;border:1px solid #222;border-radius:16px;overflow:hidden}
  .card h2{margin:0;font-size:16px;padding:12px 14px;border-bottom:1px solid #222;background:#121212}
  .card .body{padding:12px 14px}
  .btn{cursor:pointer;border:0;border-radius:12px;background:#ffd400;color:#111;padding:10px 14px;font-weight:700}
  .btn.sec{background:#1f1f1f;color:#ddd;border:1px solid #2a2a2a}
  .btn:disabled{opacity:.6;cursor:wait}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  .hint{font-size:12px;opacity:.7}
  .input{background:#0e0e0e;border:1px solid #2a2a2a;border-radius:10px;color:#eee;padding:8px 10px;width:100%}
  video,canvas,img{display:block}
  .stage{position:relative;background:#000;border-radius:16px;overflow:hidden;aspect-ratio:16/9}
  .stage video,.stage .overlay{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .stage .count{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);font-size:96px;font-weight:900}
  .stage .grid{position:absolute;inset:0;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);pointer-events:none}
  .stage .grid div{border:1px solid rgba(255,255,255,.16)}
  .gallery{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  @media (max-width: 980px){.gallery{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .thumb{border:1px solid #222;border-radius:12px;overflow:hidden;background:#0d0d0d}
  .thumb img{width:100%;height:160px;object-fit:cover}
  .thumb .bar{display:flex;gap:6px;align-items:center;justify-content:space-between;padding:8px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;padding:16px}
  .modal .box{background:#101010;border:1px solid #222;border-radius:16px;max-width:720px;width:100%;overflow:hidden}
  .modal .box h3{margin:0;padding:12px 14px;border-bottom:1px solid #222}
  .modal .box .body{padding:14px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:800px){.row2{grid-template-columns:1fr}}
  .small{font-size:12px;opacity:.8}
  .danger{color:#ff7575}
</style>

<!-- Firebase compat ser√° carregado din√¢mico quando necess√°rio -->
</head>
<body>
<div class="wrap">
  <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
    <h1 style="font-size:18px;margin:0">üì∏ Devocional Photo Booth (GSR)</h1>
    <div class="hint">Dica: abra em HTTPS (Vercel/Netlify/GitHub Pages) para a c√¢mera funcionar.</div>
  </header>

  <div class="row">
    <!-- Pr√©-visualiza√ß√£o -->
    <section class="card">
      <h2>Pr√©-visualiza√ß√£o</h2>
      <div class="body">
        <div class="stage" id="stage">
          <video id="video" playsinline muted></video>
          <img id="overlay" class="overlay" alt="" style="display:none" />
          <div id="grid" class="grid" style="display:none">
            <div></div><div></div><div></div>
            <div></div><div></div><div></div>
            <div></div><div></div><div></div>
          </div>
          <div id="count" class="count" style="display:none">3</div>
        </div>

        <div class="controls" style="margin-top:10px">
          <button class="btn sec" id="btnSwitch">Trocar c√¢mera</button>
          <button class="btn sec" id="btnGrid">Mostrar grade</button>
          <button class="btn" id="btnShot">Capturar</button>
        </div>
        <div id="err" class="small danger" style="margin-top:8px;display:none"></div>
      </div>
    </section>

    <!-- Painel -->
    <aside class="card">
      <h2>Configura√ß√µes</h2>
      <div class="body">
        <div style="display:grid;grid-template-columns:1fr;gap:10px">
          <label class="small">Dispositivo de v√≠deo
            <select id="cams" class="input"></select>
          </label>

          <div style="display:flex;gap:10px">
            <label class="small" style="flex:1">Resolu√ß√£o (largura)
              <input id="w" type="number" class="input" value="1280" min="640" step="160" />
            </label>
            <label class="small" style="flex:1">Altura
              <input id="h" type="number" class="input" value="720" min="360" step="90" />
            </label>
          </div>

          <label class="small">Moldura (PNG com transpar√™ncia)
            <input id="overlayFile" type="file" class="input" accept="image/png,image/webp,image/jpeg" />
          </label>

          <label class="small" style="display:flex;gap:6px;align-items:center">
            <input type="checkbox" id="mirror" checked />
            Espelhar pr√©via (selfie)
          </label>

          <div class="hint">Atalhos: <b>C</b> (capturar), <b>T</b> (trocar c√¢mera), <b>G</b> (grade)</div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Galeria -->
  <section class="card" style="margin-top:16px">
    <h2>Galeria</h2>
    <div class="body">
      <div id="gallery" class="gallery"></div>
      <div id="empty" class="hint">Sem capturas ainda.</div>
    </div>
  </section>

  <!-- Compartilhar (modal) -->
  <div id="shareModal" class="modal" style="display:none">
    <div class="box">
      <h3>Compartilhar foto</h3>
      <div class="body">
        <div class="row2">
          <div>
            <img id="sharePreview" alt="preview" style="width:100%;border-radius:12px" />
            <div class="small hint" style="margin-top:8px">Voc√™ tamb√©m pode baixar localmente abaixo.</div>
          </div>
          <div>
            <div id="qrBox" style="display:flex;align-items:center;justify-content:center;min-height:320px;border:1px dashed #2a2a2a;border-radius:12px;margin-bottom:10px">
              <div class="hint small">Gerando QR...</div>
            </div>
            <div class="controls">
              <a id="dlLocal" class="btn sec" download>Baixar (local)</a>
              <button id="btnCopy" class="btn sec" type="button">Copiar link</button>
              <a id="btnWA" class="btn sec" target="_blank" rel="noreferrer">WhatsApp</a>
              <button id="btnClose" class="btn" type="button">Fechar</button>
            </div>
            <div id="shareNote" class="small hint" style="margin-top:8px"></div>
          </div>
        </div>

        <details style="margin-top:14px">
          <summary>Configurar Firebase (upload sem login)</summary>
          <div class="small" style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <label>apiKey <input id="fApiKey" class="input" /></label>
            <label>authDomain <input id="fAuth" class="input" /></label>
            <label>projectId <input id="fPid" class="input" /></label>
            <label>storageBucket <input id="fBucket" class="input" /></label>
            <label>messagingSenderId <input id="fMsg" class="input" /></label>
            <label>appId <input id="fApp" class="input" /></label>
          </div>
          <div class="hint small" style="margin-top:6px">
            Regras m√≠nimas de Storage (pasta <code>devocional/**</code>): permitir <b>read</b> p√∫blico e <b>write</b> para imagens at√© 10 MB.
          </div>
        </details>

      </div>
    </div>
  </div>

</div>

<!-- Scripts -->
<script>
const els = {
  video: document.getElementById('video'),
  cams: document.getElementById('cams'),
  overlayImg: document.getElementById('overlay'),
  overlayFile: document.getElementById('overlayFile'),
  btnSwitch: document.getElementById('btnSwitch'),
  btnGrid: document.getElementById('btnGrid'),
  grid: document.getElementById('grid'),
  btnShot: document.getElementById('btnShot'),
  count: document.getElementById('count'),
  w: document.getElementById('w'),
  h: document.getElementById('h'),
  mirror: document.getElementById('mirror'),
  err: document.getElementById('err'),
  gallery: document.getElementById('gallery'),
  empty: document.getElementById('empty'),
  shareModal: document.getElementById('shareModal'),
  sharePreview: document.getElementById('sharePreview'),
  qrBox: document.getElementById('qrBox'),
  dlLocal: document.getElementById('dlLocal'),
  btnCopy: document.getElementById('btnCopy'),
  btnWA: document.getElementById('btnWA'),
  btnClose: document.getElementById('btnClose'),
  shareNote: document.getElementById('shareNote'),
  fApiKey: document.getElementById('fApiKey'),
  fAuth: document.getElementById('fAuth'),
  fPid: document.getElementById('fPid'),
  fBucket: document.getElementById('fBucket'),
  fMsg: document.getElementById('fMsg'),
  fApp: document.getElementById('fApp'),
};

let state = {
  stream: null,
  devices: [],
  deviceId: '',
  facing: 'user',
  resW: 1280,
  resH: 720,
  countdownStart: 3,
  firebaseReady: false,
  lastCapture: null,
};

const defaultFb = {
  apiKey: "AIzaSyCnMPezYybsjLnx2VBmSeWHenAJEItOzNw",
  authDomain: "devocional-gsr.firebaseapp.com",
  projectId: "devocional-gsr",
  storageBucket: "devocional-gsr.appspot.com",
  messagingSenderId: "975283886792",
  appId: "1:975283886792:web:de797e599b17ecb01fa3fd",
};
Object.assign(els,{}); // keep lints quiet
// Prefill form
els.fApiKey.value = defaultFb.apiKey;
els.fAuth.value = defaultFb.authDomain;
els.fPid.value = defaultFb.projectId;
els.fBucket.value = defaultFb.storageBucket;
els.fMsg.value = defaultFb.messagingSenderId;
els.fApp.value = defaultFb.appId;

function showError(msg){ els.err.style.display='block'; els.err.textContent = msg; }
function clearError(){ els.err.style.display='none'; els.err.textContent=''; }

async function enumerate(){
  try{
    const list = await navigator.mediaDevices.enumerateDevices();
    state.devices = list.filter(d=>d.kind==='videoinput');
    els.cams.innerHTML = state.devices.map((d,i)=>`<option value="${d.deviceId}">${d.label||('C√¢mera '+(i+1))}</option>`).join('');
    if(!state.deviceId && state.devices[0]) state.deviceId = state.devices[0].deviceId;
    els.cams.value = state.deviceId;
  }catch(e){
    showError('N√£o foi poss√≠vel listar c√¢meras. D√™ permiss√£o de c√¢mera e use HTTPS.');
    console.error(e);
  }
}

async function start(){
  clearError();
  try{
    if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); }
    const constraints = state.deviceId
      ? { video:{ deviceId:{exact:state.deviceId}, width:{ideal:state.resW}, height:{ideal:state.resH} } }
      : { video:{ facingMode: state.facing, width:{ideal:state.resW}, height:{ideal:state.resH} } };
    const s = await navigator.mediaDevices.getUserMedia(constraints);
    state.stream = s;
    els.video.srcObject = s;
    await els.video.play();
  }catch(e){
    console.error(e);
    showError('Falha ao acessar a c√¢mera. Abra via HTTPS (Vercel/Netlify) ou localhost.');
  }
}

async function init(){
  await enumerate();
  await start();
}
init();

// UI handlers
els.cams.addEventListener('change', e=>{ state.deviceId = e.target.value; start(); });
els.w.addEventListener('change', e=>{ state.resW = +e.target.value||1280; start(); });
els.h.addEventListener('change', e=>{ state.resH = +e.target.value||720; start(); });

els.btnSwitch.addEventListener('click', ()=>{
  if(state.devices.length<2){ state.facing = state.facing==='user'?'environment':'user'; state.deviceId=''; start(); }
  else{
    const idx = state.devices.findIndex(d=>d.deviceId===state.deviceId);
    const next = state.devices[(idx+1)%state.devices.length];
    state.deviceId = (next && next.deviceId) || state.deviceId;
    start();
  }
});

els.btnGrid.addEventListener('click', ()=>{
  const on = els.grid.style.display !== 'none';
  els.grid.style.display = on ? 'none' : 'grid';
  els.btnGrid.textContent = on ? 'Mostrar grade' : 'Ocultar grade';
});

els.overlayFile.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    els.overlayImg.src = reader.result;
    els.overlayImg.style.display = 'block';
  };
  reader.readAsDataURL(f);
});

document.addEventListener('keydown', (e)=>{
  const k = e.key.toLowerCase();
  if(k==='c') capture();
  if(k==='t') els.btnSwitch.click();
  if(k==='g') els.btnGrid.click();
});

els.btnShot.addEventListener('click', capture);

async function capture(){
  // contagem
  const n = state.countdownStart;
  if(n>0){
    for(let i=n;i>0;i--){
      els.count.textContent = i;
      els.count.style.display='flex';
      await new Promise(r=>setTimeout(r,1000));
    }
    els.count.style.display='none';
  }
  // render
  const v = els.video;
  const w = v.videoWidth || state.resW;
  const h = v.videoHeight || state.resH;
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');
  if(els.mirror.checked){
    ctx.translate(w,0); ctx.scale(-1,1);
  }
  ctx.drawImage(v,0,0,w,h);
  if(els.overlayImg.src){
    ctx.setTransform(1,0,0,1,0,0); // reset
    // cobre a √°rea inteira mantendo propor√ß√£o
    const o = els.overlayImg;
    const scale = Math.max(w/o.naturalWidth, h/o.naturalHeight);
    const dw = o.naturalWidth*scale, dh = o.naturalHeight*scale;
    const dx = (w-dw)/2, dy = (h-dh)/2;
    ctx.drawImage(o,dx,dy,dw,dh);
  }
  const mime = 'image/png';
  const dataUrl = c.toDataURL(mime, 0.95);
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  const name = `devocional_${ts}.png`;

  const cap = { id: ts, url: dataUrl, name, mime };
  state.lastCapture = cap;
  addToGallery(cap);
  openShare(cap);
}

function addToGallery(cap){
  els.empty.style.display='none';
  const card = document.createElement('div');
  card.className='thumb';
  card.innerHTML = `
    <img src="${cap.url}" alt="${cap.name}">
    <div class="bar">
      <span class="small" style="opacity:.8">${cap.name}</span>
      <div style="display:flex;gap:6px">
        <a class="btn sec" href="${cap.url}" download="${cap.name}">Baixar</a>
        <button class="btn sec">QR</button>
      </div>
    </div>
  `;
  card.querySelector('button').addEventListener('click', ()=>openShare(cap));
  els.gallery.prepend(card);
}

// -------- Compartilhamento / Firebase ----------
function getFirebaseConfigFromForm(){
  return {
    apiKey: els.fApiKey.value.trim(),
    authDomain: els.fAuth.value.trim(),
    projectId: els.fPid.value.trim(),
    storageBucket: els.fBucket.value.trim(),
    messagingSenderId: els.fMsg.value.trim(),
    appId: els.fApp.value.trim(),
  };
}

async function ensureFirebase(){
  if(state.firebaseReady) return true;
  const cfg = getFirebaseConfigFromForm();
  if(!cfg.apiKey || !cfg.projectId || !cfg.storageBucket || !cfg.appId){
    return false;
  }
  // carrega sdk compat
  const addScript = (src)=> new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
  try{
    if(!window.firebase){
      await addScript('https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js');
      await addScript('https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js');
    }
    window.firebase.initializeApp(cfg);
    state.firebaseReady = true;
    return true;
  }catch(e){
    console.error('Firebase init error', e);
    return false;
  }
}

async function uploadToFirebase(cap){
  const ok = await ensureFirebase();
  if(!ok) return null;
  const blob = await (await fetch(cap.url)).blob();
  const storage = window.firebase.storage();
  const path = `devocional/${new Date().toISOString().slice(0,10)}/${cap.name}`;
  const ref = storage.ref().child(path);
  await ref.put(blob, { contentType: cap.mime, cacheControl: 'public,max-age=31536000' });
  const url = await ref.getDownloadURL();
  return url;
}

function qrImage(url){
  // usa API p√∫blica para gerar QR (precisa de internet)
  const src = `https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${encodeURIComponent(url)}`;
  const img = new Image();
  img.alt = 'QR Code';
  img.src = src;
  img.style.maxWidth='100%';
  return img;
}

async function openShare(cap){
  els.sharePreview.src = cap.url;
  els.dlLocal.href = cap.url;
  els.dlLocal.download = cap.name;
  els.shareNote.textContent = "Gerando link p√∫blico‚Ä¶ (se o Firebase n√£o estiver configurado, o QR n√£o funcionar√° em outro dispositivo)";

  els.qrBox.innerHTML = '<div class="hint small">Gerando QR‚Ä¶</div>';
  els.shareModal.style.display = 'flex';

  let publicUrl = null;
  try{
    publicUrl = await uploadToFirebase(cap);
  }catch(e){
    console.error(e);
  }

  if(publicUrl){
    els.qrBox.innerHTML = '';
    els.qrBox.appendChild(qrImage(publicUrl));
    els.btnCopy.onclick = ()=> navigator.clipboard?.writeText(publicUrl);
    els.btnWA.href = `https://wa.me/?text=${encodeURIComponent('Baixe sua foto do Devocional: '+publicUrl)}`;
    els.btnWA.textContent = 'WhatsApp';
    els.shareNote.textContent = "Pronto! Aponte a c√¢mera do celular para o QR ou use o link.";
  }else{
    els.qrBox.innerHTML = '<div class="small hint">Sem Firebase configurado: n√£o h√° link p√∫blico para gerar QR v√°lido em outro dispositivo.</div>';
    els.btnCopy.onclick = ()=>{};
    els.btnWA.href = '#';
    els.btnWA.textContent = 'WhatsApp (indispon√≠vel)';
    els.shareNote.innerHTML = 'Preencha as credenciais do Firebase (aba ‚ÄúConfigurar Firebase‚Äù) e publique as <b>regras de Storage</b>. Reabra esta janela e capture novamente.';
  }
}

els.btnClose.addEventListener('click', ()=> els.shareModal.style.display='none');
</script>
</body>
</html>
